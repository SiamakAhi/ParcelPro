@model AddUpdateDocDto
@{
    ViewData["Title"] = " سنــد  " + Model.Doc.DocNumber;

    //int maxDocNumber = ViewBag.DocNumber;
    long totalBed = Model.Doc.Bed;
    long totalBes = Model.Doc.Bes;
    long ekhtelaf = totalBed >= totalBes ? totalBed - totalBes : totalBes - totalBed;

    string strTotalBed = totalBed > 0 ? totalBed.ToPrice() : "0";
    string strTotalBes = totalBes > 0 ? totalBes.ToPrice() : "0";
    string strEkhtelaf = ekhtelaf > 0 ? ekhtelaf.ToPrice() : "0";
    string status = (ekhtelaf > 0 && totalBed > totalBes) ? "بدهکار" : ((ekhtelaf > 0 && totalBes > totalBed) ? "بستانکار" : "");
}

<div class="card px-2 accDoc">
    <div class="row acc-docContent">
        <div class="col-lg-3 doc-addarticle">


            <div class="divider text-start divider-info mt-1">
                <div class="divider-text">افزودن آرتیکل</div>
            </div>
            <form asp-action="AddArticle" AddArticle asp-controller="OpAccoucnting" asp-area="" method="post">
                <input type="hidden" asp-for="Article.Id" value="@Guid.NewGuid()" />
                <input type="hidden" asp-for="Article.DocId" value="@Model.Doc.Id" />
                <input type="hidden" asp-for="Article.PeriodId" value="@Model.Doc.PeriodId" />
                <input type="hidden" asp-for="Article.SellerId" value="@Model.Doc.SellerId" />
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">شماره ردیف</label>
                        <input type="number" asp-for="Article.RowNumber" id="artRowNumber" class="form-control form-control-sm text-center" value="@(Model.Doc.Articles==null ? 1 :Model.Doc.Articles?.Count+1)">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">شماره بایگانی</label>
                        <input type="text" asp-for="Article.ArchiveCode" id="artArchiveCode" class="form-control form-control-sm text-center">
                    </div>
                    <div class="col-md-12">
                        <label class="form-label" asp-for="Article.MoeinId">حساب معین</label>
                        <select asp-for="Article.MoeinId" class="form-control form-control-sm select2" asp-items="@ViewBag.Moeins" id="frmAddArticle_MoeinId" aria-label="Default select" data-url="@Url.Action("getMoeinTafsils","OpAccoucnting",new{Area=""})">
                            <option value="0" selected>انتخاب کنید</option>
                        </select>
                    </div>
                    <div class="col-12" id="frmAddArticle_TafsilPlace">
                    </div>
                    <div class="col-md-12 mt-1">
                        <label class="form-label" asp-for="Article.Comment">شرح آرتیکل</label>
                        <div class="garnet-input-group2">
                            <input type="text" asp-for="Article.Comment" list="suggestionList" id="artDesc" class="form-control" />
                            <datalist id="suggestionList"></datalist>
                            <a href="javascript:void(0)" id="saveBtn">
                                <i class="fas fa-save"></i>
                            </a>
                        </div>
                    </div>

                </div>
                <div class="row ">
                    <div class="col-md-12">
                        <label class="form-label" asp-for="Article.Bed">مبلغ بدهکار</label>
                        <input type="text" asp-for="Article.strBed" class="form-control text-center numberInput" id="addArtBed" value="0">
                    </div>
                    <div class="col-md-12 mt-1 mb-2">
                        <label class="form-label" asp-for="Article.Bes">مبلغ بستانکار</label>
                        <input type="text" asp-for="Article.strBes" class="form-control text-center numberInput" id="addArtBes" value="0">
                    </div>

                    <div class="col-md-6 mb-2">
                        <label class="form-label" asp-for="Article.NumericalAtf">عطف عددی</label>
                        <input type="text" asp-for="Article.strNumericalAtf" class="form-control text-center numberInput gonext" value="0">
                    </div>
                    <div class="col-md-6 mb-2">
                        <label class="form-label" asp-for="Article.NumericalAtf">عطف حرفی</label>
                        <input type="text" asp-for="Article.TextAtf" class="form-control text-center gonext">
                    </div>
                    @if(ViewBag.Projects!=null){
                        <div class="col-md-12 mb-2">
                            <label class="form-label" asp-for="Article.ProjectId">انتخاب پروژه</label>
                            <select asp-for="Article.ProjectId" class="form-control form-control-sm select2" asp-items="@ViewBag.Projects">
                                <option value="0" selected>انتخاب کنید</option>
                            </select>
                        </div>
                    }

                    <div class="col-md-12 mt-1 d-grid px-3 mb-2">
                        <button type="button" id="addArt" class="btn btn-primary mb-1 accAjaxSubmit">درج</button>

                    </div>
                </div>
            </form>
            <div class="divider text-start divider-info mt-1">
            </div>
            <div class="row mt-3 p-2 doc-btncontainer">
                <div class="col-md-6 p-1">
                    <a href="#" data-url="@Url.Action("AddTafsil", "AccCoding", new { Area = "" })" class="callform btn btn-dark">
                        <i class=" bx bx-plus text-warning me-2"></i>
                        ایجاد تفصیلی
                    </a>
                </div>
                <div class="col-md-6 p-1">
                    <a href="javascript:void(0)" data-target="#docArticles" data-docid="@Model.Doc.Id" data-url="@Url.Action("ArticleRenumberRows", "OpAccoucnting", new { Area = "" })" class="renumberRows btn btn-dark">
                        <i class=" bx bx-sort-a-z text-warning me-2"></i>
                        مرتب سازی 
                    </a>
                </div>
                <div class="col-md-6 p-1">

                    <a href="javascript:void(0)" class="callformwhithid btn btn-dark" data-docnumber="@Model.Doc.DocNumber" data-docid="@Model.Doc.Id" data-url="@Url.Action("PrintDocOption", "AccPrint", new { Area = "Accounting" })">
                        <i class=" bx bx-printer me-2 text-warning"></i>
                        چاپ سنـد
                    </a>
                </div>

                <div class="col-md-6 p-1">
                   
                    <a class="btn btn-dark" asp-action="AccountingDocs" asp-controller="OpAccoucnting" asp-area="">
                        <i class=" bx bx-list-ul text-warning me-2"></i>
                         لیست اسناد
                    </a>
                </div>
                <div class="col-md-12 p-1">
                    <a href="javascript:void(0)" data-url="@Url.Action("CreateDocHeader", "OpAccoucnting", new { Area = "" })" class="btn btn-dark newdoc">
                        <i class=" bx bx-plus text-warning me-2"></i>
                        <span> سند جدید</span>
                    </a>
                </div>

            </div>

        </div>
        <div class="col-lg-9 doc">
            <div class="row">
                <div class="col-md-7">
                    <div class="garnet-group-container">
                        <div class="gotodoc">
                            <label>پیماش اسناد </label>
                            <div>
                                <a asp-action="DocViaNumber" asp-controller="OpAccoucnting" asp-area="" asp-route-number="@(Model.Doc.DocNumber+1)"><i class="bx bxs-right-arrow"></i></a>
                                <input type="number" min="1" value="@Model.Doc.DocNumber" class="text-center callDocWithNumber">
                                <a asp-action="DocViaNumber" asp-controller="OpAccoucnting" asp-area="" asp-route-number="@(Model.Doc.DocNumber-1)"><i class="bx bxs-left-arrow"></i></a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="garnet-checkbox-group">
                        <label for="tafsilVis">ستونهای تفصیلی در صورت پر بودن نمایش داده شود.</label>
                        <input type="checkbox" id="tafsilVis" />
                    </div>
                </div>
            </div>
            <div class="table-responsive static-height-600 text-nowrap hasToolbar">
                <table class="table table-striped table-bordered dataTable" id="docArticles">
                    <thead class="table-dark">
                        <tr>
                            <th class="row-chb"><input type="checkbox" id="SelectRows" /></th>
                            <th class="row-num">ردیف</th>
                            <th class="limit-text">
                                کل
                            </th>
                            <th class="limit-text">
                                معین
                            </th>

                            @if (Model.Doc.Articles?.Count > 0)
                            {
                                @if (Model.Doc.Articles.Any(n => n.Tafsil4Id != null))
                                {
                                    <th class="hide">تفصیل 4</th>
                                }
                                @if (Model.Doc.Articles.Any(n => n.Tafsil5Id != null))
                                {
                                    <th class="hide">تفصیل 5</th>
                                }
                                @if (Model.Doc.Articles.Any(n => n.Tafsil6Id != null))
                                {
                                    <th class="hide">تفصیل 6</th>
                                }
                                @if (Model.Doc.Articles.Any(n => n.Tafsil7Id != null))
                                {
                                    <th class="hide">تفصیل 7</th>
                                }
                                @if (Model.Doc.Articles.Any(n => n.Tafsil8Id != null))
                                {
                                    <th class="hide">تفصیل 8</th>
                                }
                            }

                            <th>بدهکار</th>
                            <th>بستانکار</th>
                            @if(ViewBag.Projects!=null){
                                <th>پروژه</th>
                            }
                            <th>آرشیو</th>
                            <th>
                                شرح آرتیکل
                            </th>
                            <td>
                                عطف عددی
                            </td>
                            <td>
                                عطف حرفی
                            </td>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Doc.Articles?.Count > 0)
                        {
                            foreach (var x in Model.Doc.Articles)
                            {
                                <tr id="@x.Id" data-deb="@x.Bed" data-bes="@x.Bes" class="dblc_callform" data-url="@Url.Action("EditArticle", "OpAccoucnting", new { Area = "", id = x.Id })">

                                    <td class="row-chb"><input type="checkbox" class="tblRow" name="articleRow" value="@x.Id" /></td>
                                    <td class="row-chb">@x.RowNumber</td>
                                    <td>@x.KolName</td>
                                    <td>
                                        @*   <span class="text-secondary">@x.MoeinCode</span> *@
                                        <span class="me-2">@x.MoeinName</span>
                                    </td>

                                    @if (Model.Doc.Articles.Any(n => n.Tafsil4Id != null))
                                    {
                                        <td class="hide">@x.Tafsil4Name</td>
                                    }
                                    @if (Model.Doc.Articles.Any(n => n.Tafsil5Id != null))
                                    {
                                        <td class="hide">@x.Tafsil5Name</td>
                                    }
                                    @if (Model.Doc.Articles.Any(n => n.Tafsil6Id != null))
                                    {
                                        <td class="hide">@x.Tafsil6Name</td>
                                    }
                                    @if (Model.Doc.Articles.Any(n => n.Tafsil7Id != null))
                                    {
                                        <td class="hide">@x.Tafsil7Name</td>
                                    }
                                    @if (Model.Doc.Articles.Any(n => n.Tafsil8Id != null))
                                    {
                                        <td class="hide">@x.Tafsil8Name</td>
                                    }
                                    <td>
                                        <span>@(x.Bed > 0 ? x.Bed.ToPrice() : "0")</span>
                                    </td>
                                    <td>
                                        <span>@(x.Bes > 0 ? x.Bes.ToPrice() : "0")</span>
                                    </td>
                                    @if (ViewBag.Projects != null)
                                    {
                                       <td>@x.ProjectName</td>
                                    }
                                    <td data-colname="archivecode">@x.ArchiveCode</td>
                                    <td class="limit-text" title="@x.Comment">
                                        @x.Comment
                                    </td>
                                    <td> @x.NumericalAtf.ToPrice()</td>
                                    <td> @x.TextAtf</td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button id="btnGroupDrop1" type="button" class="dropdown-toggle" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                <i class="bx bx-menu"></i>
                                            </button>
                                            <div class="dropdown-menu" aria-labelledby="btnGroupDrop1" style="">
                                                <a href="javascript:void(0)" class="dropdown-item callmodal" data-url="@Url.Action("EditArticle", "OpAccoucnting", new { Area = "", id = x.Id })"> <i class="bx bx-edit-alt text-secondary mx-1"></i> ویرایش</a>
                                                <a href="javascript:void(0)" class="dropdown-item callmodal" data-url="@Url.Action("MoveArticles", "AccFunc", new { Area = "Accounting", items = x.Id })"> <i class="bx bx-move text-secondary mx-1"></i> انتقال</a>
                                                <a href="javascript:void(0)" class="dropdown-item removeById" data-target="@x.Id" data-url="@Url.Action("DeleteDocArticle", "OpAccoucnting", new { Area = "" })"> <i class="bx bx-trash-alt text-warning mx-1"></i>حذف</a>
                                                <hr class="dropdown-divider">
                                                <ul class="row-info">
                                                    <li>
                                                        <span>ایجاد</span>
                                                    </li>
                                                    <li>
                                                        <span>@x.CreatorUserName</span>
                                                        <span>@x.CreateDate.LatinToPersian()</span>
                                                    </li>
                                                    @if (!string.IsNullOrEmpty(x.EditorUserName))
                                                    {
                                                        <li>
                                                            <span>ویرایش </span>
                                                            <hr class="dropdown-divider">

                                                        </li>
                                                        <li>
                                                            <span>@x.CreatorUserName</span>
                                                            <span>@x.CreateDate.LatinToPersian()</span>
                                                        </li>
                                                    }
                                                </ul>
                                            </div>
                                        </div>
                                    
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                        }
                    </tbody>

                </table>
            </div>

            <div class="doc-footer">


                <div class="row">
                    <div class="col-md-7 toolbar-table">
                        <div class="open my-2" id="sumRowsPlace">
                            <div class="bulkActionBox">
                                <div>
                                    <div class="btn-group" role="group" aria-label="First group">

                                        <a href="javascript:void(0)" data-target="#frm-doc" data-url="@Url.Action("", "OpAccoucnting", new { Area = "" })" class="btn btn-info mb-1">
                                            <i class="tf-icons bx bx-copy me-2"></i>
                                            کپی ردیف های انتخاب شده
                                        </a>

                                        <a class="btn btn-danger  bulkAction" href="#" data-tableid="docArticles" data-url="@Url.Action("DelArticles", "AccFunc", new { Area = "Accounting" })" data-allerttext="ردیف های انتخاب شده حذف شوند ؟" title="حذف ردیفها ">
                                            <i class="bx bx-trash me-2 text-white"></i>
                                            <span>حذف ردیف های انتخاب شده</span>
                                        </a>

                                    </div>
                                </div>
                                <div class="alert-secondary">
                                    <ul class="accountinfoBox me-2">
                                        <li>
                                            <label class="text-secondary">بدهکار  </label>
                                            <span class="text16" id="totalBed"></span>
                                        </li>
                                        <li>
                                            <label class="text-secondary">بستانکار </label>
                                            <span class="text16" id="totalBes"></span>
                                        </li>
                                        <li>
                                            <label class="text-secondary">اختلاف </label>
                                            <span class="text16 text-danger" id="ekhtelaf"></span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="docForm alert-secondary mt-1">
                            <div class="docForm-body">
                                <form asp-action="" asp-controller="" asp-area="" method="post" id="frm-doc">
                                    <div class="row">
                                        <input type="hidden" asp-for="Doc.Id" value="@Model.Doc.Id" />
                                        <input type="hidden" asp-for="Doc.PeriodId" value="@Model.Doc.PeriodId" />
                                        <input type="hidden" asp-for="Doc.SellerId" value="@Model.Doc.SellerId" />
                                        <input type="hidden" asp-for="Doc.StatusId" value="@Model.Doc.StatusId" />
                                        <input type="hidden" asp-for="Doc.AutoDocNumber" value="@Model.Doc.StatusId" />

                                        <div class="col-sm-1">
                                             <h4 class="autoDocNumber text-warning">@Model.Doc.AutoDocNumber</h4>
                                        </div>
                                        <div class="col-sm-4">
                                            <label class="form-label" asp-for="Doc.TypeId"></label>
                                            <select asp-for="Doc.TypeId" class="form-select form-select-sm" asp-items="@ViewBag.DocTypes" aria-label="Default select">
                                            </select>
                                        </div>
                                        <div class="col-sm-4">
                                            <label class="form-label" asp-for="Doc.DocDate"></label>
                                            <input type="text" asp-for="Doc.strDocDate" value="@Model.Doc.DocDate.Value.LatinToPersian()" class="form-control form-control-sm flatpickr-input" placeholder="YYYY/MM/DD" id="flatpickr-date">
                                        </div>
                                        <div class="col-sm-3 ">
                                            <label class="form-label" asp-for="Doc.DocNumber"></label>
                                            <input type="number" min="1" asp-for="Doc.DocNumber" class="form-control form-control-sm text-center">
                                        </div>

                                        <div class="col-sm-3">
                                            <label class="form-label" asp-for="Doc.AtfNumber"></label>
                                            <input type="number" asp-for="Doc.AtfNumber" class="form-control text-center">
                                        </div>
                                        <div class="col-sm-9 mt-1">
                                            <label class="form-label" asp-for="Doc.Description"></label>
                                            <textarea rows="1" asp-for="Doc.Description" class="form-control form-control-sm" placeholder="شرح سنـد"></textarea>
                                        </div>
                                    </div>
                                </form>
                            </div>


                            <div class="buttonbox">
                                <a href="javascript:void(0)" data-target="#frm-doc" data-url="@Url.Action("SaveDraftDoc", "OpAccoucnting", new { Area = "" })" class="accAjaxSaveDoc">
                                    <i class="tf-icons bx bx-note me-2"></i>
                                    ذخیره یادداشت
                                </a>
                                <a href="javascript:void(0)" data-target="#frm-doc" class="accAjaxSaveDoc" data-url="@Url.Action("SaveTemptDoc", "OpAccoucnting", new { Area = "" })">
                                    <i class="tf-icons bx bx-save me-2"></i>
                                    ثبت موقت
                                </a>
                            </div>
                        </div>

                    </div>

                    <div class="col-md-5">
                        <form asp-action="SaveDraftDoc" asp-controller="OpAccoucnting" asp-area="" method="get">
                            <ul class="docfooter-totalAmounts">
                                <li>
                                    <label>جمع بدهکار : </label>
                                    <div>

                                        <input type="text" readonly value="@strTotalBed" />
                                        <span class="text-sm-end">ريال</span>
                                    </div>
                                </li>
                                <li>
                                    <label>جمع بستانکار : </label>
                                    <div>
                                        <input type="text" readonly value="@strTotalBes" />
                                        <span class="text-sm-end">ريال</span>
                                    </div>
                                </li>
                                <li>
                                    <label class="docBalance">
                                        @if (status == "بدهکار")
                                        {
                                            <span class="badge badge-dot bg-label-danger px-3">@status</span>
                                        }
                                        else if (status == "بستانکار")
                                        {
                                            <span class="badge badge-dot bg-label-danger px-3">@status</span>
                                        }
                                        else
                                        {
                                            <span class="badge badge-dot bg-label-success px-3">تـراز</span>
                                        }

                                    </label>
                                    <div>
                                        <input type="text" class="text-danger" readonly value="@strEkhtelaf" />
                                        <span class="text-sm-end text-danger">ريال</span>
                                    </div>
                                </li>
                            </ul>
                        </form>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script src="~/vendor/libs/jquery/jquery.js"></script>
<script type="text/javascript">

    $(document).ready(function () {
        $('#artRowNumber').select();

        let artBed = $('#addArtBed');
        let artBes = $('#addArtBes');
        let docBed = parseInt("@totalBed");
        let docBes = parseInt("@totalBes");
        let docEkhtelaf = "@strEkhtelaf";
        if (docBed > docBes)
            artBes.val(docEkhtelaf);
        else
            artBed.val(docEkhtelaf);

        //
        var archiveTotals = {};

        // Loop through each row in the table
        $('#docArticles tbody tr').each(function () {
            var archiveCode = $(this).find('td.archive-code').text().trim();
            var bed = parseFloat($(this).find('td.bed span').text().replace(/,/g, '')) || 0;
            var bes = parseFloat($(this).find('td.bes span').text().replace(/,/g, '')) || 0;

            if (archiveCode) {
                if (!archiveTotals[archiveCode]) {
                    archiveTotals[archiveCode] = { bed: 0, bes: 0 };
                }

                archiveTotals[archiveCode].bed += bed;
                archiveTotals[archiveCode].bes += bes;
            }
        });

        // اسکرول به آخرین ردیف جدول
        // اسکرول نرم به آخرین ردیف جدول
        var $tableContainer = $('.table-responsive');
        var $lastRow = $('#docArticles tbody tr:last');
        if ($lastRow.length > 0) {
            $tableContainer.animate({
                scrollTop: $lastRow.position().top - $tableContainer.position().top + $tableContainer.scrollTop()
            }, 500);
        }

        //Suggestion ---------------
        // نمایش پیشنهادات با توجه به حروف تایپ شده
        document.getElementById('artDesc').addEventListener('input', function () {
            showSuggestions();
        });

        // نمایش پیشنهادات
        function showSuggestions() {
            let datalist = document.getElementById('suggestionList');
            datalist.innerHTML = ''; // پاک‌سازی لیست قبلی

            let inputValue = document.getElementById('artDesc').value.trim();
            let storedValues = JSON.parse(localStorage.getItem('storedValues')) || [];

            // فقط مقادیری که شامل عبارت تایپ شده هستند نمایش داده شود
            storedValues
                .filter(value => value.toLowerCase().includes(inputValue.toLowerCase()))
                .forEach(value => {
                    let option = document.createElement('option');
                    option.value = value;
                    datalist.appendChild(option);
                });
        }

        // ذخیره مقدار جدید با کلیک روی دکمه ذخیره
        document.getElementById('saveBtn').addEventListener('click', function () {
            let inputValue = document.getElementById('artDesc').value.trim();

            if (inputValue.split(' ').length > 1) { // فقط ذخیره عبارات بیش از یک کلمه
                let storedValues = JSON.parse(localStorage.getItem('storedValues')) || [];

                // جلوگیری از ذخیره مقادیر تکراری
                if (!storedValues.includes(inputValue)) {
                    storedValues.push(inputValue);
                    localStorage.setItem('storedValues', JSON.stringify(storedValues));
                    alert("عبارت با موفقیت ذخیره شد.");
                } else {
                    alert("این عبارت قبلا ذخیره شده است.");
                }
            } else {
                alert("لطفا عبارتی با بیش از یک کلمه وارد کنید.");
            }
        });

        // لود پیشنهادات در زمان بارگذاری صفحه
        window.addEventListener('load', showSuggestions);


    });

</script>







